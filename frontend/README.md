# Layer 1: The Environment Machine (Host)

**Philosophy**: "The mandatory, privileged interface to the hardware."

This directory contains the logic for the "Body" of the node. In INOS v2.1, the browser/host is not just a UI renderer, but a hardware abstraction layer (HAL) for the sensor mesh.

## Role
- **I/O Master**: It is the *only* component allowed to touch the DOM or Hardware. It serializes all input into `io/v1/sensor.capnp` formats (Lidar, Video, GPIO) before passing them to the Kernel.
- **Actuator**: It listens for `io/v1/actor.capnp` commands from the Kernel to render Holograms (`Three.js`) or move Robots (`WebSerial`).
- **Zero-Copy Spine**: Manages `SharedArrayBuffer` for high-performance data transfer between the JS Host, Go Kernel, and Rust Modules.

## Structure
- **`nginx/`**: High-performance ingress termination + Brotli compression.
- **`app/`**: The visual shell (React + Vite).
- **`bridge/`**: The Critical Glue.
    - Instantiates WASM runtimes.
    - Maps `SharedArrayBuffer` memory.
    - Routes events between the DOM and the Kernel.

## ðŸ“š Recommended Libraries

*   **`rxjs` (Stream Management)**:
    *   **Role**: The "Event Spine" of the Environment Machine.
    *   **Contribution**: It transforms raw, chaotic WebTransport datagrams into ordered, typed Observables.
    *   **Mechanism**: Uses operators like `multiplex()` to split a single socket connection into virtual channels (e.g., `sensor$`, `audio$`, `control$`). It handles backpressure ("The kernel is busy, slow down sensor reading") via `throttleTime` or `buffer`.
*   **`@react-three/fiber` (Visuals)**:
    *   **Role**: The "Renderer Interface".
    *   **Contribution**: Decouples the visual state from the render loop. Allows React to manage the "Scene Graph" (Entities) while Three.js handles the "Frame Loop" (60fps).
    *   **Mechanism**: React components map 1:1 to Three.js objects. When a Rust Capsule updates a position in `SharedArrayBuffer`, a Fiber component subscribes to that memory address and updates the visual mesh efficiently.
*   **`apache-arrow-js` (Big Data)**:
    *   **Role**: The "Zero-Copy Analytics Layer".
    *   **Contribution**: Allows the UI to display massive datasets (millions of rows) generated by Rust without serializing them into JS Objects.
    *   **Mechanism**: The UI reads directly from the binary column buffers in memory to render charts or tables.

## ðŸ— Architecture & Capabilities

The **Environment Machine** is the only layer that can touch the real world. It acts as a servant to the Kernel.

### The Zero-Copy Spine (Pseudocode)

```javascript
class EnvironmentMachine {
    constructor() {
        // 1. Allocate Shared Memory (100MB)
        this.memory = new WebAssembly.Memory({ shared: true, initial: 1600 });
        this.sab = this.memory.buffer;
        
        // 2. Initialize Views
        this.heapU8 = new Uint8Array(this.sab);
    }
    
    async boot() {
        // 3. Load Kernel (Go)
        this.kernel = await GoWASM.instantiate(this.sab);
        
        // 4. Load Sensor Module (Rust)
        this.sensorCapsule = await RustWASM.instantiate("lidar_processor.wasm", this.sab);
        
        // 5. Connect Sensor Stream -> SAB
        navigator.serial.addEventListener('connect', (e) => {
            const reader = e.target.readable.getReader();
            // Stream directly into shared memory at Offset X
            streamToMemory(reader, this.heapU8, OFFSET_SENSOR_BUFFER);
            
            // Notify Kernel
            this.kernel.notify("sensor:data_ready");
        });
    }
}
```

## ðŸ§ª Test Requirements

1.  **Unit Tests (Bridge)**:
    *   Verify `SharedArrayBuffer` is correctly shared between independent Workers.
    *   Test `Atomics.notify` and `Atomics.wait` behavior for distinct browser environments.

2.  **Integration Tests (Sensors)**:
    *   Mock `navigator.serial` and `navigator.bluetooth` APIs.
    *   Ensure data piped into the mock flows into the WASM memory correctly.

3.  **E2E Tests (Rendering)**:
    *   Verify Three.js/WebGPU scenes render correctly when driven by WASM state updates (visual regression testing).
